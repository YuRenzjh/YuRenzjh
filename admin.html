<!-- ğŸ“ æ­¤æ–‡ä»¶ç”± GitHub Agent ç”Ÿæˆï¼Œç”¨äºåå°ç®¡ç†é¡µé¢ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ç»“æ„ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åå°ç®¡ç† | ä¸ªäººåšå®¢</title>
  <style>
    /* CSS å˜é‡ - è«å…°è¿ªè“ç³» */
    :root {
      --blue-calm: #8CA3AD;
      --blue-joy: #A7B9C2;
      --blue-thought: #6E7F8D;
      --blue-inspire: #5A6D7D;
      --blue-tranquil: #F8F9FA;
      --blue-gentle: #4A5B6B;
      
      --color-primary: var(--blue-inspire);
      --color-secondary: var(--blue-calm);
      --bg-primary: #FFFFFF;
      --bg-secondary: var(--blue-tranquil);
      --text-primary: #2C3E50;
      --text-secondary: #5A6C7D;
      --text-muted: #8899A6;
      --border-color: #E8EDF2;
      
      --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);
      --transition-fast: 0.2s var(--ease-smooth);
      --transition-normal: 0.3s var(--ease-smooth);
      --radius-sm: 6px;
      --radius-md: 12px;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .header h1 {
      font-size: 1.75rem;
      color: var(--color-primary);
      margin-bottom: 0.5rem;
    }
    
    .header p {
      color: var(--text-muted);
    }
    
    /* æˆæƒé¡µé¢ */
    .auth-section {
      text-align: center;
      padding: 4rem 2rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }
    
    .auth-section h2 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    .auth-section p {
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .btn:hover {
      background: var(--blue-gentle);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--color-primary);
      color: var(--color-primary);
    }
    
    .btn-outline:hover {
      background: var(--color-primary);
      color: white;
    }
    
    /* è¡¨å•æ ·å¼ */
    .form-section {
      display: none;
    }
    
    .form-section.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .form-label .required {
      color: #E74C3C;
    }
    
    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all var(--transition-fast);
    }
    
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(90, 109, 125, 0.15), 0 0 15px rgba(90, 109, 125, 0.1);
    }
    
    .form-textarea {
      min-height: 300px;
      resize: vertical;
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .form-help {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    
    /* å¤šé€‰æ¡†ç»„ */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 1.125rem;
      height: 1.125rem;
      accent-color: var(--color-primary);
    }
    
    /* å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ */
    .image-upload {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .image-upload:hover {
      border-color: var(--color-primary);
      background: var(--bg-secondary);
    }
    
    .image-upload input {
      display: none;
    }
    
    .image-preview {
      max-width: 200px;
      max-height: 150px;
      margin-top: 1rem;
      border-radius: var(--radius-sm);
    }
    
    /* Toast æç¤º */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 1rem 2rem;
      background: var(--text-primary);
      color: white;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      opacity: 0;
      transition: all var(--transition-normal);
      z-index: 1000;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      background: #27AE60;
    }
    
    .toast.error {
      background: #E74C3C;
    }
    
    /* é”™è¯¯æç¤ºåŒºåŸŸ */
    .error-fallback {
      background: #FFF3E0;
      border: 1px solid #FFB74D;
      border-radius: var(--radius-md);
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: none;
    }
    
    .error-fallback.show {
      display: block;
    }
    
    .error-fallback h3 {
      color: #E65100;
      margin-bottom: 0.5rem;
    }
    
    .error-fallback p {
      color: #BF360C;
      margin-bottom: 1rem;
    }
    
    .markdown-output {
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: 1rem;
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* é…ç½®åŒºåŸŸ */
    .config-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .config-section h3 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    .config-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 600px) {
      .config-row {
        grid-template-columns: 1fr;
      }
    }
    
    /* ç”¨æˆ·ä¿¡æ¯ */
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 2rem;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
    
    .user-name {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .user-logout {
      margin-left: auto;
      font-size: 0.9rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    
    .user-logout:hover {
      color: #E74C3C;
    }
    
    /* è¡¨å•æ“ä½œæ  */
    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
    }
    
    /* è¿”å›é“¾æ¥ */
    .back-link {
      display: inline-block;
      color: var(--text-muted);
      margin-bottom: 1rem;
      text-decoration: none;
    }
    
    .back-link:hover {
      color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    
    <div class="header">
      <h1>ğŸ“ åšå®¢åå°ç®¡ç†</h1>
      <p>é€šè¿‡ GitHub API ç›´æ¥å‘å¸ƒæ–‡ç« </p>
    </div>
    
    <!-- æˆæƒé¡µé¢ -->
    <div id="auth-section" class="auth-section">
      <h2>ğŸ” éœ€è¦ GitHub æˆæƒ</h2>
      <p>é¦–æ¬¡ä½¿ç”¨éœ€è¦æˆæƒ GitHub è´¦å·ï¼Œä»¥ä¾¿é€šè¿‡ API å‘å¸ƒæ–‡ç« åˆ°æ‚¨çš„ä»“åº“ã€‚</p>
      <button id="auth-btn" class="btn">
        ğŸ”— æˆæƒ GitHub
      </button>
      <p class="form-help" style="margin-top: 1rem;">
        æˆæƒä¿¡æ¯ä»…å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šå‘é€åˆ°ä»»ä½•ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚
      </p>
    </div>
    
    <!-- è¡¨å•é¡µé¢ -->
    <div id="form-section" class="form-section">
      <div id="user-info" class="user-info" style="display: none;">
        <img id="user-avatar" class="user-avatar" src="" alt="ç”¨æˆ·å¤´åƒ">
        <div>
          <div id="user-name" class="user-name"></div>
          <div id="user-repo" style="font-size: 0.85rem; color: var(--text-muted);"></div>
        </div>
        <span id="logout-btn" class="user-logout">é€€å‡ºç™»å½•</span>
      </div>
      
      <!-- ä»“åº“é…ç½® -->
      <div class="config-section">
        <h3>âš™ï¸ ä»“åº“é…ç½®</h3>
        <div class="config-row">
          <div class="form-group">
            <label class="form-label">ä»“åº“æ‰€æœ‰è€… <span class="required">*</span></label>
            <input type="text" id="repo-owner" class="form-input" placeholder="ä¾‹å¦‚: YuRenzjh">
          </div>
          <div class="form-group">
            <label class="form-label">ä»“åº“åç§° <span class="required">*</span></label>
            <input type="text" id="repo-name" class="form-input" placeholder="ä¾‹å¦‚: YuRenZjh">
          </div>
        </div>
      </div>
      
      <form id="post-form">
        <div class="form-group">
          <label class="form-label">æ–‡ç« æ ‡é¢˜ <span class="required">*</span></label>
          <input type="text" id="title" class="form-input" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">å¿ƒæƒ… <span class="required">*</span></label>
          <select id="mood" class="form-select" required>
            <option value="">è¯·é€‰æ‹©å¿ƒæƒ…...</option>
            <option value="å¹³é™">ğŸ’™ å¹³é™</option>
            <option value="é›€è·ƒ">ğŸ’› é›€è·ƒ</option>
            <option value="æ²‰æ€">ğŸ–¤ æ²‰æ€</option>
            <option value="çµæ„Ÿ">ğŸ’œ çµæ„Ÿ</option>
            <option value="ä¼¤æ„Ÿ">ğŸ¤ ä¼¤æ„Ÿ</option>
            <option value="æ¸©æŸ”">ğŸ©µ æ¸©æŸ”</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">åˆ†ç±»</label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="æŠ€æœ¯"> æŠ€æœ¯
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="ç”Ÿæ´»"> ç”Ÿæ´»
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="è¯»ä¹¦"> è¯»ä¹¦
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="å½±éŸ³"> å½±éŸ³
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="é—²èŠ"> é—²èŠ
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="åæ§½"> åæ§½
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="category" value="å…¶ä»–"> å…¶ä»–
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">æ ‡ç­¾</label>
          <input type="text" id="tags" class="form-input" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šæ—¥è®°, å¿ƒæƒ…, è®°å½•">
          <p class="form-help">å¤šä¸ªæ ‡ç­¾è¯·ç”¨è‹±æ–‡é€—å·åˆ†éš”</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">æ‘˜è¦</label>
          <input type="text" id="excerpt" class="form-input" placeholder="æ–‡ç« ç®€çŸ­æè¿°ï¼ˆå¯é€‰ï¼‰">
        </div>
        
        <div class="form-group">
          <label class="form-label">å°é¢å›¾ï¼ˆå¯é€‰ï¼‰</label>
          <div class="image-upload" id="image-upload">
            <p>ğŸ“· ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
            <input type="file" id="cover-image" accept="image/*">
            <img id="image-preview" class="image-preview" style="display: none;">
          </div>
          <p class="form-help">å›¾ç‰‡å°†è½¬æ¢ä¸º base64 å­˜å‚¨åœ¨ front matter ä¸­</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">æ­£æ–‡å†…å®¹ <span class="required">*</span></label>
          <textarea id="content" class="form-textarea" placeholder="æ”¯æŒ Markdown æ ¼å¼..." required></textarea>
          <p class="form-help">æ”¯æŒå®Œæ•´çš„ Markdown è¯­æ³•</p>
        </div>
        
        <div class="form-actions">
          <button type="submit" id="submit-btn" class="btn">
            ğŸ“¤ å‘å¸ƒæ–‡ç« 
          </button>
          <button type="button" id="preview-btn" class="btn btn-outline">
            ğŸ‘ï¸ é¢„è§ˆ Markdown
          </button>
        </div>
      </form>
      
      <!-- é”™è¯¯é™çº§åŒºåŸŸ -->
      <div id="error-fallback" class="error-fallback">
        <h3>âš ï¸ å‘å¸ƒå¤±è´¥</h3>
        <p id="error-message">è¯·å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼Œæ‰‹åŠ¨åœ¨ GitHub ä»“åº“ä¸­åˆ›å»ºæ–‡ä»¶ã€‚</p>
        <div id="markdown-output" class="markdown-output"></div>
        <div style="margin-top: 1rem;">
          <button id="copy-markdown" class="btn btn-outline" style="margin-right: 0.5rem;">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
          <a id="github-link" href="#" target="_blank" class="btn">ğŸ”— æ‰“å¼€ GitHub ç¼–è¾‘å™¨</a>
        </div>
      </div>
    </div>
    
    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>
  </div>
  
  <script>
    // ========== é…ç½® ==========
    const CONFIG = {
      // GitHub OAuth åº”ç”¨é…ç½®
      // æ³¨æ„ï¼šéœ€è¦åœ¨ GitHub åˆ›å»º OAuth App å¹¶å¡«å…¥ Client ID
      // æˆæƒå›è°ƒ URL è®¾ç½®ä¸º: https://your-domain.com/admin.html
      CLIENT_ID: '', // éœ€è¦ç”¨æˆ·è‡ªè¡Œå¡«å†™
      REDIRECT_URI: window.location.origin + '/admin.html',
      SCOPE: 'repo',
    };
    
    // ========== å·¥å…·å‡½æ•° ==========
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    
    // ç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ˆç”¨äº PKCEï¼‰
    function generateRandomString(length = 64) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      const array = new Uint8Array(length);
      crypto.getRandomValues(array);
      return Array.from(array, (byte) => chars[byte % chars.length]).join('');
    }
    
    // SHA256 å“ˆå¸Œ
    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return hash;
    }
    
    // Base64 URL ç¼–ç 
    function base64urlEncode(buffer) {
      const bytes = new Uint8Array(buffer);
      let str = '';
      bytes.forEach((byte) => { str += String.fromCharCode(byte); });
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    
    // UTF-8 å­—ç¬¦ä¸²è½¬ Base64ï¼ˆç”¨äºæ”¯æŒä¸­æ–‡å†…å®¹ï¼‰
    function utf8ToBase64(str) {
      const encoder = new TextEncoder();
      const bytes = encoder.encode(str);
      let binary = '';
      bytes.forEach((byte) => { binary += String.fromCharCode(byte); });
      return btoa(binary);
    }
    
    // æ˜¾ç¤º Toast
    function showToast(message, type = 'info') {
      const toast = $('#toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(date) {
      const d = date || new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // ç”Ÿæˆæ–‡ä»¶å
    function generateFilename(title) {
      const date = formatDate();
      // ä¿ç•™ä¸­æ–‡æ ‡é¢˜ï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦
      const safeTitle = title.replace(/[\/\\:*?"<>|]/g, '').trim();
      return `${date}-${safeTitle}.md`;
    }
    
    // ========== OAuth æµç¨‹ ==========
    async function startOAuth() {
      if (!CONFIG.CLIENT_ID) {
        showToast('è¯·å…ˆé…ç½® GitHub OAuth Client ID', 'error');
        showManualTokenInput();
        return;
      }
      
      // ç”Ÿæˆ PKCE code verifier å’Œ challenge
      const codeVerifier = generateRandomString(64);
      const codeChallenge = base64urlEncode(await sha256(codeVerifier));
      const state = generateRandomString(32);
      
      // å­˜å‚¨ verifier å’Œ state ç”¨äºå›è°ƒéªŒè¯
      sessionStorage.setItem('oauth_code_verifier', codeVerifier);
      sessionStorage.setItem('oauth_state', state);
      
      // æ„å»ºæˆæƒ URL
      const authUrl = new URL('https://github.com/login/oauth/authorize');
      authUrl.searchParams.set('client_id', CONFIG.CLIENT_ID);
      authUrl.searchParams.set('redirect_uri', CONFIG.REDIRECT_URI);
      authUrl.searchParams.set('scope', CONFIG.SCOPE);
      authUrl.searchParams.set('state', state);
      authUrl.searchParams.set('code_challenge', codeChallenge);
      authUrl.searchParams.set('code_challenge_method', 'S256');
      
      window.location.href = authUrl.toString();
    }
    
    // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ Token çš„æ–¹å¼
    function showManualTokenInput() {
      const authSection = $('#auth-section');
      authSection.innerHTML = `
        <h2>ğŸ”‘ æ‰‹åŠ¨è¾“å…¥ Personal Access Token</h2>
        <p style="margin-bottom: 1rem;">ç”±äºæœªé…ç½® OAuth Appï¼Œè¯·ä½¿ç”¨ GitHub Personal Access Token è¿›è¡Œæˆæƒã€‚</p>
        <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-muted);">
          <a href="https://github.com/settings/tokens/new?scopes=repo&description=Blog%20Admin" target="_blank" style="color: var(--color-primary);">
            ç‚¹å‡»è¿™é‡Œåˆ›å»º Personal Access Token
          </a>
          ï¼ˆéœ€è¦å‹¾é€‰ repo æƒé™ï¼‰
        </p>
        <div class="form-group" style="max-width: 400px; margin: 0 auto;">
          <input type="password" id="manual-token" class="form-input" placeholder="ç²˜è´´æ‚¨çš„ Personal Access Token">
        </div>
        <button id="manual-auth-btn" class="btn" style="margin-top: 1rem;">
          ğŸ”“ ä½¿ç”¨ Token ç™»å½•
        </button>
      `;
      
      $('#manual-auth-btn').addEventListener('click', async () => {
        const token = $('#manual-token').value.trim();
        if (!token) {
          showToast('è¯·è¾“å…¥ Token', 'error');
          return;
        }
        
        // éªŒè¯ Token
        try {
          const response = await fetch('https://api.github.com/user', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Token æ— æ•ˆ');
          }
          
          const user = await response.json();
          sessionStorage.setItem('github_token', token);
          sessionStorage.setItem('github_user', JSON.stringify(user));
          
          showToast('æˆæƒæˆåŠŸï¼', 'success');
          showFormSection(user);
        } catch (error) {
          showToast('Token éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®', 'error');
        }
      });
    }
    
    // å¤„ç† OAuth å›è°ƒ
    async function handleOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      
      if (error) {
        showToast(`æˆæƒå¤±è´¥: ${error}`, 'error');
        return false;
      }
      
      if (!code) {
        return false;
      }
      
      // éªŒè¯ state
      const savedState = sessionStorage.getItem('oauth_state');
      if (state !== savedState) {
        showToast('æˆæƒçŠ¶æ€éªŒè¯å¤±è´¥', 'error');
        return false;
      }
      
      // æ³¨æ„ï¼šç”±äº GitHub OAuth ä¸æ”¯æŒçº¯å‰ç«¯ PKCE æµç¨‹è·å– token
      // è¿™é‡Œæç¤ºç”¨æˆ·ä½¿ç”¨ Personal Access Token æ–¹å¼
      showToast('GitHub OAuth éœ€è¦åç«¯æœåŠ¡æ”¯æŒï¼Œè¯·ä½¿ç”¨ Personal Access Token', 'error');
      showManualTokenInput();
      
      // æ¸…ç† URL å‚æ•°
      window.history.replaceState({}, document.title, window.location.pathname);
      return true;
    }
    
    // ========== UI æ§åˆ¶ ==========
    function showFormSection(user) {
      $('#auth-section').style.display = 'none';
      $('#form-section').classList.add('active');
      
      if (user) {
        $('#user-info').style.display = 'flex';
        $('#user-avatar').src = user.avatar_url || '';
        $('#user-name').textContent = user.login || 'ç”¨æˆ·';
        
        // è‡ªåŠ¨å¡«å……ä»“åº“ä¿¡æ¯
        const repoOwner = $('#repo-owner');
        const repoName = $('#repo-name');
        
        if (!repoOwner.value) {
          repoOwner.value = user.login;
        }
      }
    }
    
    function showAuthSection() {
      $('#auth-section').style.display = 'block';
      $('#form-section').classList.remove('active');
      $('#user-info').style.display = 'none';
    }
    
    // ========== æ–‡ç« å‘å¸ƒ ==========
    function generateMarkdown() {
      const title = $('#title').value.trim();
      const mood = $('#mood').value;
      const tags = $('#tags').value.trim();
      const excerpt = $('#excerpt').value.trim();
      const content = $('#content').value.trim();
      const coverImage = sessionStorage.getItem('cover_image_base64') || '';
      
      // è·å–é€‰ä¸­çš„åˆ†ç±»
      const categories = Array.from($$('input[name="category"]:checked'))
        .map(cb => cb.value);
      
      // æ„å»º front matter
      let frontMatter = `---
title: "${title}"
date: ${formatDate()}
mood: "${mood}"`;
      
      if (categories.length > 0) {
        frontMatter += `\ncategories: [${categories.join(', ')}]`;
      }
      
      if (tags) {
        const tagList = tags.split(',').map(t => t.trim()).filter(Boolean);
        frontMatter += `\ntags: [${tagList.join(', ')}]`;
      }
      
      if (excerpt) {
        frontMatter += `\nexcerpt: "${excerpt}"`;
      }
      
      if (coverImage) {
        frontMatter += `\ncover_image: "${coverImage}"`;
      }
      
      frontMatter += `\n---\n\n`;
      
      return frontMatter + content;
    }
    
    async function publishPost() {
      const token = sessionStorage.getItem('github_token');
      if (!token) {
        showToast('è¯·å…ˆç™»å½•', 'error');
        return;
      }
      
      const owner = $('#repo-owner').value.trim();
      const repo = $('#repo-name').value.trim();
      const title = $('#title').value.trim();
      
      if (!owner || !repo) {
        showToast('è¯·å¡«å†™ä»“åº“é…ç½®', 'error');
        return;
      }
      
      if (!title) {
        showToast('è¯·å¡«å†™æ–‡ç« æ ‡é¢˜', 'error');
        return;
      }
      
      const filename = generateFilename(title);
      const content = generateMarkdown();
      const path = `_posts/${filename}`;
      
      // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
      const submitBtn = $('#submit-btn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> å‘å¸ƒä¸­...';
      submitBtn.disabled = true;
      
      try {
        // è°ƒç”¨ GitHub API åˆ›å»ºæ–‡ä»¶
        const response = await fetch(
          `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `ğŸ“ æ–°æ–‡ç« : ${title}`,
              content: utf8ToBase64(content),
              branch: 'main'
            })
          }
        );
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'å‘å¸ƒå¤±è´¥');
        }
        
        showToast('ğŸ‰ æ–‡ç« å‘å¸ƒæˆåŠŸï¼10ç§’åè·³è½¬é¦–é¡µ...', 'success');
        
        // æ¸…ç†è¡¨å•
        $('#post-form').reset();
        sessionStorage.removeItem('cover_image_base64');
        $('#image-preview').style.display = 'none';
        
        // 10ç§’åè·³è½¬é¦–é¡µ
        setTimeout(() => {
          window.location.href = '/';
        }, 10000);
        
      } catch (error) {
        console.error('å‘å¸ƒå¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯é™çº§
        showErrorFallback(error.message, content, filename, owner, repo);
        
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }
    
    function showErrorFallback(errorMessage, content, filename, owner, repo) {
      const fallback = $('#error-fallback');
      const errorMsgEl = $('#error-message');
      const markdownOutput = $('#markdown-output');
      const githubLink = $('#github-link');
      
      let detailedError = 'å‘å¸ƒå¤±è´¥';
      
      if (errorMessage.includes('rate limit')) {
        detailedError = 'GitHub API è¯·æ±‚æ¬¡æ•°è¶…é™ï¼Œè¯·ç¨åå†è¯•æˆ–å¤åˆ¶å†…å®¹æ‰‹åŠ¨å‘å¸ƒã€‚';
      } else if (errorMessage.includes('Bad credentials') || errorMessage.includes('401')) {
        detailedError = 'Token å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚';
      } else if (errorMessage.includes('Not Found') || errorMessage.includes('404')) {
        detailedError = 'ä»“åº“ä¸å­˜åœ¨æˆ–æ²¡æœ‰è®¿é—®æƒé™ï¼Œè¯·æ£€æŸ¥ä»“åº“é…ç½®ã€‚';
      } else if (errorMessage.includes('network') || errorMessage.includes('fetch')) {
        detailedError = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•æˆ–å¤åˆ¶å†…å®¹æ‰‹åŠ¨å‘å¸ƒã€‚';
      } else {
        detailedError = `å‘å¸ƒå¤±è´¥: ${errorMessage}ã€‚è¯·å¤åˆ¶ä»¥ä¸‹å†…å®¹æ‰‹åŠ¨åœ¨ GitHub åˆ›å»ºæ–‡ä»¶ã€‚`;
      }
      
      errorMsgEl.textContent = detailedError;
      markdownOutput.textContent = content;
      githubLink.href = `https://github.com/${owner}/${repo}/new/main/_posts?filename=${encodeURIComponent(filename)}`;
      
      fallback.classList.add('show');
      showToast(detailedError, 'error');
    }
    
    // ========== äº‹ä»¶ç»‘å®š ==========
    document.addEventListener('DOMContentLoaded', async () => {
      // æ£€æŸ¥æ˜¯å¦æœ‰ OAuth å›è°ƒ
      const isCallback = await handleOAuthCallback();
      
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      const token = sessionStorage.getItem('github_token');
      const userStr = sessionStorage.getItem('github_user');
      
      if (token && userStr) {
        try {
          const user = JSON.parse(userStr);
          showFormSection(user);
        } catch {
          showAuthSection();
        }
      } else if (!isCallback) {
        // é»˜è®¤æ˜¾ç¤ºæ‰‹åŠ¨ Token è¾“å…¥æ–¹å¼
        showManualTokenInput();
      }
      
      // æˆæƒæŒ‰é’®
      const authBtn = $('#auth-btn');
      if (authBtn) {
        authBtn.addEventListener('click', startOAuth);
      }
      
      // é€€å‡ºç™»å½•
      $('#logout-btn')?.addEventListener('click', () => {
        sessionStorage.removeItem('github_token');
        sessionStorage.removeItem('github_user');
        sessionStorage.removeItem('cover_image_base64');
        showToast('å·²é€€å‡ºç™»å½•', 'info');
        location.reload();
      });
      
      // è¡¨å•æäº¤
      $('#post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await publishPost();
      });
      
      // é¢„è§ˆæŒ‰é’®
      $('#preview-btn').addEventListener('click', () => {
        const content = generateMarkdown();
        $('#markdown-output').textContent = content;
        $('#error-fallback').classList.add('show');
        $('#error-message').textContent = 'ä»¥ä¸‹æ˜¯å³å°†å‘å¸ƒçš„æ–‡ç« å†…å®¹é¢„è§ˆ:';
      });
      
      // å¤åˆ¶ Markdown
      $('#copy-markdown').addEventListener('click', async () => {
        const content = $('#markdown-output').textContent;
        try {
          await navigator.clipboard.writeText(content);
          showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } catch {
          showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
        }
      });
      
      // å›¾ç‰‡ä¸Šä¼ 
      const imageUpload = $('#image-upload');
      const coverImageInput = $('#cover-image');
      const imagePreview = $('#image-preview');
      
      imageUpload.addEventListener('click', () => coverImageInput.click());
      
      imageUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUpload.style.borderColor = 'var(--color-primary)';
      });
      
      imageUpload.addEventListener('dragleave', () => {
        imageUpload.style.borderColor = 'var(--border-color)';
      });
      
      imageUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUpload.style.borderColor = 'var(--border-color)';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          handleImageFile(file);
        }
      });
      
      coverImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleImageFile(file);
        }
      });
      
      function handleImageFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const base64 = e.target.result;
          sessionStorage.setItem('cover_image_base64', base64);
          imagePreview.src = base64;
          imagePreview.style.display = 'block';
          showToast('å›¾ç‰‡å·²ä¸Šä¼ ', 'success');
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
